<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR Master - Enterprise Edition</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Shared Logic -->
    <script src="utils.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#1e293b', 900: '#0f172a' },
                        primary: { 50: '#eef2ff', 100: '#e0e7ff', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca' }
                    },
                    fontFamily: { sans: ['Inter', 'Cairo', 'sans-serif'] }
                }
            }
        }
    </script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, addDoc, query, where, onSnapshot, orderBy, serverTimestamp, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyBTLUtRTuECf4SKZ_Jf33Gr1oFvnq1OnnQ",
            authDomain: "hr-master-127af.firebaseapp.com",
            projectId: "hr-master-127af",
            storageBucket: "hr-master-127af.firebasestorage.app",
            messagingSenderId: "475367853980",
            appId: "1:475367853980:web:cb5bf55397b2a7ffb30259"
        };

        try {
            const app = initializeApp(firebaseConfig);
            window.auth = getAuth(app);
            window.db = getFirestore(app);
            window.signInWithEmailAndPassword = signInWithEmailAndPassword;
            window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
            window.signOut = signOut;
            window.onAuthStateChanged = onAuthStateChanged;
            window.collection = collection;
            window.doc = doc;
            window.setDoc = setDoc;
            window.getDoc = getDoc;
            window.getDocs = getDocs;
            window.addDoc = addDoc;
            window.updateDoc = updateDoc;
            window.deleteDoc = deleteDoc;
            window.query = query;
            window.where = where;
            window.onSnapshot = onSnapshot;
            window.orderBy = orderBy;
            window.serverTimestamp = serverTimestamp;
            window.firebaseLoaded = true;
            console.log("System Online âœ…");
        } catch (e) {
            console.error("Firebase Init Error:", e);
            window.firebaseLoaded = false;
        }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .font-arabic { font-family: 'Cairo', sans-serif; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @media print {
            @page { size: A4; margin: 10mm; }
            body { background: white; font-size: 11pt; -webkit-print-color-adjust: exact; }
            .no-print, nav, header, button:not(.print-allow) { display: none !important; }
            .print-only { display: block !important; }
            .print-container { position: relative; width: 100%; box-shadow: none; border: none; margin: 0; padding: 0; }
            .card-shadow { box-shadow: none !important; border: 1px solid #ddd; }
        }
    </style>
</head>
<body class="text-slate-800 antialiased h-screen overflow-hidden">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const DEFAULT_SHIFT_START = "09:00";

        const TRANSLATIONS = {
            en: {
                appName: "HR Master", dashboard: "Dashboard", attendance: "Attendance", employees: "Staff Directory", reports: "Analytics", requests: "Requests", chat: "Team Connect", meetings: "Meetings",
                login: "Sign In", register: "Join Company", email: "Email Address", password: "Password", fullName: "Full Name", department: "Department", role: "Job Title", salary: "Base Salary",
                welcome: "Welcome back,", checkIn: "Punch In", checkOut: "Punch Out", status: "Status", online: "Online", onsite: "On-Site", create: "Create", cancel: "Cancel", submit: "Submit",
                gpsRequired: "GPS Location Required", accessDenied: "Restricted Access", addEmployee: "Add Employee", save: "Save Changes", loginError: "Invalid credentials.",
                noAccount: "New here? Create an account.", haveAccount: "Have an account? Sign in.", roles: { hr: "HR Manager", manager: "Manager", employee: "Employee" },
                edit: "Edit", delete: "Delete", confirmDelete: "Are you sure? This action is irreversible.", actions: "Actions", printReport: "Print PDF", reportType: "Report Type",
                allDepts: "All Departments", filterByDept: "Filter Department", employeeReport: "Employee Profile", attendanceReport: "Attendance Log",
                totalEmployees: "Total Staff", totalSalary: "Est. Payroll", generatedOn: "Generated:", myRequests: "My Requests", manageRequests: "Approvals", newRequest: "New Request",
                type: "Type", reason: "Description", pending: "Pending", approved: "Approved", rejected: "Rejected", approve: "Approve", reject: "Reject",
                loan: "Loan", leave: "Leave", permission: "Exit Permit", overtime: "Overtime", reqSuccess: "Request Sent Successfully",
                scheduleMeeting: "Schedule Meeting", meetingTitle: "Subject", join: "Join", accountPending: "Account Under Review",
                pendingMessage: "Your account is currently pending HR approval.", joinRequests: "Join Requests", activeEmployees: "Active Staff",
                approveUser: "Approve", rejectUser: "Decline", viewProfile: "Full Profile", position: "Position", shiftStart: "Shift Start", shiftEnd: "Shift End",
                netSalary: "Net Salary", deductions: "Deductions", custody: "Assets", lateness: "Late (min)", addCustody: "Add Asset", addDeduction: "Add Deduction",
                itemName: "Item Name", amount: "Amount", date: "Date", from: "From", to: "To", cost: "Cost", pendingActions: "Pending Actions",
                channels: "Channels", directMessages: "Direct Messages", generalChannel: "General", deptChannel: "My Dept"
            },
            ar: {
                appName: "Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©", dashboard: "Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…", attendance: "Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù", employees: "Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†", reports: "Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª", requests: "Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØ§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª",
                chat: "Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ", meetings: "Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹Ø§Øª", login: "Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…", register: "Ø·Ù„Ø¨ Ø§Ù†Ø¶Ù…Ø§Ù…", email: "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ", password: "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±",
                fullName: "Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ", department: "Ø§Ù„Ù‚Ø³Ù… / Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©", role: "Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ", salary: "Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ", welcome: "Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒØŒ",
                checkIn: "ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±", checkOut: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù†ØµØ±Ø§Ù", status: "Ø§Ù„Ø­Ø§Ù„Ø©", online: "Ù…ØªØµÙ„", onsite: "ÙÙŠ Ø§Ù„Ù…Ù‚Ø±", create: "Ø¥Ù†Ø´Ø§Ø¡", cancel: "Ø¥Ù„ØºØ§Ø¡", submit: "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨",
                gpsRequired: "ÙŠØ¬Ø¨ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù€ GPS", accessDenied: "ÙˆØµÙˆÙ„ Ù…Ù‚ÙŠØ¯ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø© ÙÙ‚Ø·", addEmployee: "Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯", save: "Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", loginError: "Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©.",
                noAccount: "Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯ØŸ Ø³Ø¬Ù„ Ù‡Ù†Ø§.", haveAccount: "Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ.", roles: { hr: "Ù…Ø¯ÙŠØ± Ù…ÙˆØ§Ø±Ø¯ Ø¨Ø´Ø±ÙŠØ©", manager: "Ù…Ø¯ÙŠØ± Ù‚Ø³Ù…", employee: "Ù…ÙˆØ¸Ù" },
                edit: "ØªØ¹Ø¯ÙŠÙ„", delete: "Ø­Ø°Ù", confirmDelete: "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹.", actions: "Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª", printReport: "Ø·Ø¨Ø§Ø¹Ø© PDF", reportType: "Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±",
                allDepts: "ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…", filterByDept: "ÙÙ„ØªØ± Ø§Ù„Ù‚Ø³Ù…", employeeReport: "Ù…Ù„Ù Ø§Ù„Ù…ÙˆØ¸Ù", attendanceReport: "Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ±", totalEmployees: "Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†",
                totalSalary: "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ÙˆØ§ØªØ¨", generatedOn: "ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±:", myRequests: "Ø·Ù„Ø¨Ø§ØªÙŠ", manageRequests: "Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª", newRequest: "Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯",
                type: "Ø§Ù„Ù†ÙˆØ¹", reason: "Ø§Ù„ØªÙØ§ØµÙŠÙ„", pending: "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©", approved: "Ù…Ù‚Ø¨ÙˆÙ„", rejected: "Ù…Ø±ÙÙˆØ¶", approve: "Ù…ÙˆØ§ÙÙ‚Ø©", reject: "Ø±ÙØ¶",
                loan: "Ø³Ù„ÙØ© Ù…Ø§Ù„ÙŠØ©", leave: "Ø¥Ø¬Ø§Ø²Ø©", permission: "Ø¥Ø°Ù† Ø§Ù†ØµØ±Ø§Ù", overtime: "Ø¹Ù…Ù„ Ø¥Ø¶Ø§ÙÙŠ", reqSuccess: "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­",
                scheduleMeeting: "Ø¬Ø¯ÙˆÙ„Ø© Ø§Ø¬ØªÙ…Ø§Ø¹", meetingTitle: "Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹", join: "Ø§Ù†Ø¶Ù…Ø§Ù…", accountPending: "Ø§Ù„Ø­Ø³Ø§Ø¨ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©",
                pendingMessage: "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­. ÙŠØ±Ø¬Ù‰ Ø§Ù†ØªØ¸Ø§Ø± Ù…ÙˆØ§ÙÙ‚Ø© Ù‚Ø³Ù… Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©.", joinRequests: "Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…", activeEmployees: "Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†",
                approveUser: "ØªÙØ¹ÙŠÙ„", rejectUser: "Ø±ÙØ¶", viewProfile: "Ø§Ù„Ù…Ù„Ù Ø§Ù„ÙƒØ§Ù…Ù„", position: "Ø§Ù„Ù…Ù†ØµØ¨", shiftStart: "Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø´ÙØª", shiftEnd: "Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø´ÙØª",
                netSalary: "ØµØ§ÙÙŠ Ø§Ù„Ø±Ø§ØªØ¨", deductions: "Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª ÙˆØ§Ù„Ø¬Ø²Ø§Ø¡Ø§Øª", custody: "Ø§Ù„ÙØ¹Ù‡Ø¯", lateness: "ØªØ£Ø®ÙŠØ± (Ø¯Ù‚ÙŠÙ‚Ø©)", addCustody: "Ø¥Ø¶Ø§ÙØ© Ø¹Ù‡Ø¯Ø©",
                addDeduction: "Ø¥Ø¶Ø§ÙØ© Ø®ØµÙ…", itemName: "Ø§Ø³Ù… Ø§Ù„Ø¹Ù‡Ø¯Ø©", amount: "Ø§Ù„Ù…Ø¨Ù„Øº", date: "Ø§Ù„ØªØ§Ø±ÙŠØ®", from: "Ù…Ù†", to: "Ø¥Ù„Ù‰", cost: "Ø§Ù„ØªÙƒÙ„ÙØ©", pendingActions: "Ù…Ù‡Ø§Ù… Ù…Ø¹Ù„Ù‚Ø©",
                channels: "Ø§Ù„Ù‚Ù†ÙˆØ§Øª", directMessages: "Ø±Ø³Ø§Ø¦Ù„ Ù…Ø¨Ø§Ø´Ø±Ø©", generalChannel: "Ø¹Ø§Ù…", deptChannel: "Ù‚Ø³Ù…ÙŠ"
            }
        };

        const Icon = ({ name, size = 20, className }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (window.lucide && ref.current) {
                    ref.current.innerHTML = '';
                    const i = document.createElement('i'); i.setAttribute('data-lucide', name); ref.current.appendChild(i);
                    window.lucide.createIcons({ root: ref.current, nameAttr: 'data-lucide', attrs: { width: size, height: size, class: className } });
                }
            }, [name, size, className]);
            return <span ref={ref} style={{ display: 'inline-flex' }}></span>;
        };

        const ToastContext = React.createContext();
        const ToastProvider = ({ children }) => {
            const [toasts, setToasts] = useState([]);
            const addToast = (msg, type = 'info') => {
                const id = Date.now(); setToasts(prev => [...prev, { id, msg, type }]);
                setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), 4000);
            };
            return (
                <ToastContext.Provider value={addToast}>
                    {children}
                    <div className="fixed top-6 right-6 z-50 flex flex-col gap-3 pointer-events-none">
                        {toasts.map(t => (
                            <div key={t.id} className={`pointer-events-auto min-w-[320px] p-4 rounded-xl shadow-xl border-l-4 flex items-center gap-3 bg-white animate-fade-in ${t.type === 'success' ? 'border-green-500 text-green-700' : t.type === 'error' ? 'border-red-500 text-red-700' : 'border-blue-500 text-blue-700'}`}>
                                <Icon name={t.type === 'success' ? 'check-circle' : 'info'} size={20} /><span className="font-semibold text-sm">{t.msg}</span>
                            </div>
                        ))}
                    </div>
                </ToastContext.Provider>
            );
        };
        const useToast = () => React.useContext(ToastContext);

        // Global Delete Handler
        const useGlobalDelete = (user) => {
            const showToast = useToast();
            return async (collectionName, id, description = "Item") => {
                if (!['HR', 'Manager'].includes(user.role)) {
                    showToast("Access Denied", "error");
                    return false;
                }

                if (!confirm("Are you sure you want to delete this?")) return false;

                if (user.role === 'Manager') {
                    try {
                        await window.deleteDoc(window.doc(window.db, collectionName, id));
                        showToast("Deleted Successfully", "success");
                        return true;
                    } catch (e) {
                        showToast("Delete Failed", "error");
                        console.error(e);
                        return false;
                    }
                } else if (user.role === 'HR') {
                    try {
                        await window.addDoc(window.collection(window.db, "deletion_requests"), {
                            targetCollection: collectionName,
                            targetId: id,
                            description,
                            requestedBy: user.uid,
                            requesterName: user.name,
                            timestamp: window.serverTimestamp(),
                            status: 'Pending'
                        });
                        showToast("Deletion Request Sent to Manager", "success");
                        return true; // Return true as action handled
                    } catch (e) {
                        showToast("Request Failed", "error");
                        console.error(e);
                        return false;
                    }
                }
            };
        };

        const PermissionHelpModal = ({ onClose }) => (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                <div className="bg-white rounded-2xl max-w-2xl w-full p-8 shadow-2xl relative border border-slate-100">
                    <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-slate-700"><Icon name="x" /></button>
                    <h3 className="text-xl font-bold text-red-600 mb-4">Database Access Required</h3>
                    <div className="bg-slate-900 text-green-400 p-4 rounded-xl font-mono text-xs overflow-x-auto mb-6"><pre>{`rules_version = '2';\nservice cloud.firestore {\n  match /databases/{database}/documents {\n    match /{document=**} {\n      allow read, write: if request.auth != null;\n    }\n  }\n}`}</pre></div>
                    <button onClick={() => window.location.reload()} className="w-full bg-slate-900 text-white py-3 rounded-xl font-bold hover:bg-slate-800">I Updated Rules, Reload</button>
                </div>
            </div>
        );

        const PendingScreen = ({ t, onLogout }) => (
            <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                <div className="bg-white p-10 rounded-3xl shadow-xl w-full max-w-lg text-center border border-slate-200">
                    <div className="w-20 h-20 bg-amber-50 rounded-full flex items-center justify-center mx-auto mb-6 text-amber-500 animate-pulse"><Icon name="clock" size={40} /></div>
                    <h2 className="text-2xl font-bold text-slate-800 mb-3">{t.accountPending}</h2>
                    <p className="text-slate-500 mb-8 leading-relaxed">{t.pendingMessage}</p>
                    <button onClick={onLogout} className="px-8 py-3 bg-slate-900 text-white rounded-xl font-bold hover:bg-slate-800 transition-colors flex items-center gap-2 mx-auto"><Icon name="log-out" size={18} /> Logout</button>
                </div>
            </div>
        );

        const AuthScreen = ({ t, onLogin, onError }) => {
            const [isRegister, setIsRegister] = useState(false);
            const [formData, setFormData] = useState({ email: '', password: '', name: '' });
            const [loading, setLoading] = useState(false);
            const showToast = useToast();

            const handleSubmit = async (e) => {
                e.preventDefault(); setLoading(true);
                if (!window.firebaseLoaded) { setTimeout(() => onLogin({ uid: 'demo', email: formData.email, role: 'HR', name: 'Demo User', status: 'active' }), 1000); return; }
                try {
                    if (isRegister) {
                        const cred = await window.createUserWithEmailAndPassword(window.auth, formData.email, formData.password);
                        try { await window.setDoc(window.doc(window.db, "users", cred.user.uid), { uid: cred.user.uid, name: formData.name, email: formData.email, role: 'Employee', department: 'General', salary: 0, status: 'pending', createdAt: window.serverTimestamp() }); } 
                        catch(e) { if(e.code === 'permission-denied') onError(); }
                    } else { await window.signInWithEmailAndPassword(window.auth, formData.email, formData.password); }
                } catch (err) { showToast(t.loginError, "error"); } finally { setLoading(false); }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                    <div className="bg-white p-8 md:p-12 rounded-3xl shadow-2xl w-full max-w-md border border-slate-100">
                        <div className="flex justify-center mb-8"><div className="w-16 h-16 bg-primary-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-primary-200"><Icon name="hexagon" size={32} /></div></div>
                        <h2 className="text-3xl font-bold text-center mb-2 text-slate-900">{isRegister ? t.register : t.login}</h2>
                        <form onSubmit={handleSubmit} className="space-y-5">
                            {isRegister && (<div><label className="text-xs font-bold text-slate-500 uppercase">{t.fullName}</label><input type="text" required className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-primary-500 outline-none mt-1" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} /></div>)}
                            <div><label className="text-xs font-bold text-slate-500 uppercase">{t.email}</label><input type="email" required className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-primary-500 outline-none mt-1" value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} /></div>
                            <div><label className="text-xs font-bold text-slate-500 uppercase">{t.password}</label><input type="password" required className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-primary-500 outline-none mt-1" value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})} /></div>
                            <button type="submit" disabled={loading} className="w-full py-3.5 bg-primary-600 text-white rounded-xl font-bold hover:bg-primary-700 transition-all shadow-lg shadow-primary-200 disabled:opacity-70 flex justify-center">{loading ? "..." : (isRegister ? t.create : t.login)}</button>
                        </form>
                        <div className="mt-6 text-center"><button onClick={() => setIsRegister(!isRegister)} className="text-sm font-medium text-primary-600 hover:text-primary-800">{isRegister ? t.haveAccount : t.noAccount}</button></div>
                    </div>
                </div>
            );
        };

        const Dashboard = ({ t, user, setView, requests = [], users = [] }) => {
            const pendingRequests = requests.filter(r => r.status === 'Pending').length;
            const pendingUsers = users.filter(u => u.status === 'pending').length;
            const isManager = ['HR', 'Manager'].includes(user.role);

            return (
                <div className="space-y-8 animate-fade-in pb-10">
                    <div className="bg-gradient-to-r from-slate-800 to-slate-900 rounded-3xl p-8 text-white shadow-xl relative overflow-hidden">
                        <div className="relative z-10"><h2 className="text-3xl font-bold mb-2">{t.welcome} {user.name} ðŸ‘‹</h2><p className="opacity-80 text-sm max-w-lg">Manage your team, track attendance, and handle requests efficiently.</p></div>
                        <Icon name="activity" size={180} className="absolute -right-10 -bottom-10 text-white opacity-5" />
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-4"><div className="w-14 h-14 rounded-2xl bg-green-50 text-green-600 flex items-center justify-center"><Icon name="user-check" size={28}/></div><div><p className="text-sm text-slate-500 font-medium">{t.status}</p><h3 className="text-lg font-bold text-slate-800">Active</h3></div></div>
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-4"><div className="w-14 h-14 rounded-2xl bg-blue-50 text-blue-600 flex items-center justify-center"><Icon name="briefcase" size={28}/></div><div><p className="text-sm text-slate-500 font-medium">{t.department}</p><h3 className="text-lg font-bold text-slate-800">{user.department}</h3></div></div>
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-4"><div className="w-14 h-14 rounded-2xl bg-purple-50 text-purple-600 flex items-center justify-center"><Icon name="shield" size={28}/></div><div><p className="text-sm text-slate-500 font-medium">{t.role}</p><h3 className="text-lg font-bold text-slate-800">{user.role}</h3></div></div>
                    </div>
                    {isManager && (pendingRequests > 0 || pendingUsers > 0) && (
                        <div className="bg-orange-50 border border-orange-100 rounded-2xl p-6"><h3 className="font-bold text-orange-800 mb-4 flex items-center gap-2"><Icon name="bell" size={20}/> {t.pendingActions}</h3><div className="flex gap-4">{pendingRequests > 0 && <button onClick={() => setView('requests')} className="bg-white text-orange-600 px-4 py-2 rounded-xl text-sm font-bold shadow-sm border border-orange-200">{pendingRequests} {t.requests}</button>}{pendingUsers > 0 && <button onClick={() => setView('employees')} className="bg-white text-orange-600 px-4 py-2 rounded-xl text-sm font-bold shadow-sm border border-orange-200">{pendingUsers} {t.joinRequests}</button>}</div></div>
                    )}
                    <div>
                        <h3 className="font-bold text-lg mb-4 text-slate-700">{t.quickActions}</h3>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <button onClick={() => setView('attendance')} className="p-5 bg-white rounded-2xl shadow-sm border border-slate-100 hover:border-primary-200 hover:shadow-md transition-all text-center group"><div className="w-12 h-12 mx-auto bg-primary-50 text-primary-600 rounded-xl flex items-center justify-center mb-3 group-hover:scale-110 transition-transform"><Icon name="clock" size={24}/></div><span className="font-semibold text-slate-700 text-sm">{t.attendance}</span></button>
                            <button onClick={() => setView('requests')} className="p-5 bg-white rounded-2xl shadow-sm border border-slate-100 hover:border-primary-200 hover:shadow-md transition-all text-center group"><div className="w-12 h-12 mx-auto bg-emerald-50 text-emerald-600 rounded-xl flex items-center justify-center mb-3 group-hover:scale-110 transition-transform"><Icon name="file-plus" size={24}/></div><span className="font-semibold text-slate-700 text-sm">{t.newRequest}</span></button>
                            <button onClick={() => setView('chat')} className="p-5 bg-white rounded-2xl shadow-sm border border-slate-100 hover:border-primary-200 hover:shadow-md transition-all text-center group"><div className="w-12 h-12 mx-auto bg-blue-50 text-blue-600 rounded-xl flex items-center justify-center mb-3 group-hover:scale-110 transition-transform"><Icon name="message-square" size={24}/></div><span className="font-semibold text-slate-700 text-sm">{t.chat}</span></button>
                            <button onClick={() => setView('meetings')} className="p-5 bg-white rounded-2xl shadow-sm border border-slate-100 hover:border-primary-200 hover:shadow-md transition-all text-center group"><div className="w-12 h-12 mx-auto bg-purple-50 text-purple-600 rounded-xl flex items-center justify-center mb-3 group-hover:scale-110 transition-transform"><Icon name="video" size={24}/></div><span className="font-semibold text-slate-700 text-sm">{t.meetings}</span></button>
                        </div>
                    </div>
                </div>
            );
        };

        const EmployeeProfile = ({ t, employee, onBack, isHR, onError, onEdit }) => {
            const [logs, setLogs] = useState([]);
            const [custodyList, setCustodyList] = useState([]);
            const [deductionsList, setDeductionsList] = useState([]);
            const [activeTab, setActiveTab] = useState('attendance');
            const [newItem, setNewItem] = useState({ name: '', date: new Date().toISOString().split('T')[0] });
            const [newDeduction, setNewDeduction] = useState({ amount: '', reason: '', date: new Date().toISOString().split('T')[0] });

            // Use shared logic from utils.js
            const { totalLateness, totalDeductions, lateCost, netSalary } = useMemo(() => {
                if (!window.HRUtils) return { totalLateness:0, totalDeductions:0, lateCost:0, netSalary:0 };
                return window.HRUtils.calculateFinancials(employee, logs, deductionsList);
            }, [employee, logs, deductionsList]);

            useEffect(() => {
                if(window.firebaseLoaded) {
                    // FIX: Remove orderBy to avoid index error
                    const qL = window.query(window.collection(window.db, "attendance"), window.where("userId", "==", employee.uid));
                    const unsubL = window.onSnapshot(qL, s => {
                        const data = s.docs.map(d => ({id:d.id, ...d.data()}));
                        data.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                        setLogs(data);
                    }, (e) => { if(e.code === 'permission-denied' && onError) onError(); });
                    
                    const qC = window.query(window.collection(window.db, "custody"), window.where("userId", "==", employee.uid));
                    const unsubC = window.onSnapshot(qC, s => setCustodyList(s.docs.map(d => ({id:d.id, ...d.data()}))), (e) => { if(e.code === 'permission-denied' && onError) onError(); });
                    
                    const qD = window.query(window.collection(window.db, "deductions"), window.where("userId", "==", employee.uid));
                    const unsubD = window.onSnapshot(qD, s => setDeductionsList(s.docs.map(d => ({id:d.id, ...d.data()}))), (e) => { if(e.code === 'permission-denied' && onError) onError(); });

                    return () => { unsubL(); unsubC(); unsubD(); }
                }
            }, [employee.uid]);

            const addItem = async (coll, data, setter, reset) => { if(!window.firebaseLoaded) return; await window.addDoc(window.collection(window.db, coll), { userId: employee.uid, ...data }); setter(reset); };

            return (
                <div className="space-y-6 pb-10 animate-fade-in">
                    <div className="flex justify-between items-center no-print">
                        <button onClick={onBack} className="flex items-center gap-2 text-slate-500 hover:text-slate-800 font-bold"><Icon name="arrow-left" size={20} /> Back</button>
                        {isHR && onEdit && <button onClick={() => onEdit(employee)} className="flex items-center gap-2 bg-slate-100 text-slate-700 px-4 py-2 rounded-xl font-bold text-sm hover:bg-slate-200 transition-colors"><Icon name="edit" size={16}/> {t.edit}</button>}
                    </div>
                    <div className="bg-white rounded-3xl p-8 shadow-sm border border-slate-200 flex flex-col md:flex-row gap-8 relative overflow-hidden print-container">
                        <div className="absolute top-0 left-0 w-full h-24 bg-gradient-to-r from-primary-600 to-primary-800"></div>
                        <div className="relative z-10 mt-4 md:mt-0"><div className="w-28 h-28 rounded-full border-4 border-white shadow-lg bg-slate-100 flex items-center justify-center text-3xl font-bold text-slate-400">{employee.name?.charAt(0)}</div></div>
                        <div className="relative z-10 flex-1 pt-4 md:pt-10"><h1 className="text-3xl font-bold text-slate-900">{employee.name}</h1><p className="text-primary-600 font-bold uppercase text-xs tracking-wider mb-4">{employee.position || t.role}</p><div className="grid grid-cols-2 gap-4 text-sm text-slate-500"><div className="flex gap-2 items-center"><Icon name="mail" size={14}/> {employee.email}</div><div className="flex gap-2 items-center"><Icon name="briefcase" size={14}/> {employee.department}</div></div></div>
                        <div className="relative z-10 pt-4 md:pt-10 min-w-[200px]"><div className="bg-slate-50 p-4 rounded-xl border border-slate-100"><p className="text-xs text-slate-400 uppercase font-bold">{t.netSalary}</p><p className="text-3xl font-bold text-emerald-600 font-mono">${netSalary.toLocaleString()}</p></div></div>
                    </div>
                    <div className="flex gap-1 border-b border-slate-200 no-print">{['attendance', 'financials', 'custody'].map(key => (<button key={key} onClick={() => setActiveTab(key)} className={`px-6 py-3 font-bold text-sm border-b-2 transition-all ${activeTab === key ? 'border-primary-600 text-primary-700' : 'border-transparent text-slate-400 hover:text-slate-600'}`}>{key === 'financials' ? t.deductions : t[key]}</button>))}</div>
                    <div className="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 min-h-[400px]">
                        {activeTab === 'attendance' && (<div><div className="flex gap-3 mb-6"><span className="px-3 py-1 bg-slate-100 rounded text-xs font-bold text-slate-600">{t.shiftStart}: {employee.shiftStart || DEFAULT_SHIFT_START}</span><span className="px-3 py-1 bg-slate-100 rounded text-xs font-bold text-slate-600">{t.shiftEnd}: {employee.shiftEnd || "17:00"}</span><span className="px-3 py-1 bg-red-50 text-red-600 rounded text-xs font-bold">{t.lateness}: {totalLateness}m</span></div><table className="w-full text-sm text-left"><thead className="bg-slate-50 text-slate-500"><tr><th className="p-3">{t.date}</th><th className="p-3">Time</th><th className="p-3">{t.status}</th><th className="p-3">{t.lateness}</th><th className="p-3">Loc</th></tr></thead><tbody className="divide-y divide-slate-100">{logs.map(l => { const late = l.type === 'in' ? window.HRUtils?.calculateLateness(l.timestamp.seconds, employee.shiftStart) : 0; return (<tr key={l.id}><td className="p-3 font-medium">{new Date(l.timestamp.seconds*1000).toLocaleDateString()}</td><td className="p-3 font-mono">{new Date(l.timestamp.seconds*1000).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</td><td className="p-3"><span className={`px-2 py-0.5 rounded text-xs font-bold ${l.type==='in'?'bg-emerald-50 text-emerald-700':'bg-rose-50 text-rose-700'}`}>{l.type.toUpperCase()}</span></td><td className="p-3 text-red-600 font-bold">{late > 0 ? `+${late}m` : '-'}</td><td className="p-3 text-xs text-slate-400 max-w-[100px] truncate">{l.location}</td></tr>)})}</tbody></table></div>)}
                        {activeTab === 'financials' && (<div className="grid md:grid-cols-2 gap-8"><div><h3 className="font-bold mb-4">{t.deductions}</h3><div className="space-y-2 mb-4">{deductionsList.map(d => (<div key={d.id} className="flex justify-between p-3 bg-red-50 rounded-lg border border-red-100 text-sm"><span>{d.reason} <span className="text-slate-400 text-xs ml-2">{d.date}</span></span><span className="font-bold text-red-600">-${d.amount}</span></div>))}<div className="flex justify-between p-3 bg-orange-50 rounded-lg border border-orange-100 text-sm"><span>Late Fees ({totalLateness}m)</span><span className="font-bold text-orange-600">-${lateCost}</span></div></div>{isHR && <form onSubmit={(e) => {e.preventDefault(); addItem('deductions', newDeduction, setNewDeduction, {amount:'',reason:'',date:''})}} className="flex gap-2 pt-4 border-t"><input className="flex-1 p-2 border rounded text-sm" placeholder={t.reason} value={newDeduction.reason} onChange={e=>setNewDeduction({...newDeduction,reason:e.target.value})} /><input className="w-20 p-2 border rounded text-sm" type="number" placeholder="$" value={newDeduction.amount} onChange={e=>setNewDeduction({...newDeduction,amount:e.target.value})} /><button className="px-3 bg-red-600 text-white rounded text-sm font-bold">{t.save}</button></form>}</div><div className="bg-slate-50 p-6 rounded-2xl h-fit border border-slate-200"><h3 className="font-bold mb-4 border-b pb-2">Payslip Preview</h3><div className="space-y-2 text-sm"><div className="flex justify-between"><span>Base Salary</span><span className="font-mono">${Number(employee.salary).toLocaleString()}</span></div><div className="flex justify-between text-red-500"><span>Deductions</span><span className="font-mono">-${totalDeductions}</span></div><div className="flex justify-between text-orange-500"><span>Late Fees</span><span className="font-mono">-${lateCost}</span></div><div className="flex justify-between font-bold text-lg pt-2 border-t mt-2"><span>Net Pay</span><span className="font-mono text-emerald-600">${netSalary.toLocaleString()}</span></div></div></div></div>)}
                        {activeTab === 'custody' && (<div><h3 className="font-bold mb-4">{t.custody}</h3><div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">{custodyList.map(c => (<div key={c.id} className="p-4 bg-blue-50 rounded-xl border border-blue-100 flex justify-between items-center"><div><p className="font-bold text-slate-800">{c.name}</p><p className="text-xs text-blue-400">{c.date}</p></div><Icon name="box" className="text-blue-300" /></div>))}</div>{isHR && <form onSubmit={(e) => {e.preventDefault(); addItem('custody', newItem, setNewItem, {name:'',date:''})}} className="flex gap-2 max-w-md"><input className="flex-1 p-2 border rounded text-sm" placeholder={t.itemName} value={newItem.name} onChange={e=>setNewItem({...newItem,name:e.target.value})} /><input className="w-32 p-2 border rounded text-sm" type="date" value={newItem.date} onChange={e=>setNewItem({...newItem,date:e.target.value})} /><button className="px-4 bg-primary-600 text-white rounded text-sm font-bold">{t.save}</button></form>}</div>)}
                    </div>
                </div>
            );
        };

        const Employees = ({ t, user, onError }) => {
            const [users, setUsers] = useState([]);
            const [tab, setTab] = useState('active');
            const [viewId, setViewId] = useState(null);
            const [showForm, setShowForm] = useState(false);
            const [formData, setFormData] = useState({});
            const showToast = useToast();
            const handleDelete = useGlobalDelete(user);

            useEffect(() => {
                if(!window.firebaseLoaded) return;
                const unsub = window.onSnapshot(window.collection(window.db, "users"), (s) => setUsers(s.docs.map(d => ({id:d.id, ...d.data()}))), (e) => { if(e.code === 'permission-denied' && onError) onError(); });
                return () => unsub();
            }, []);

            const handleAction = async (action, id, data = null) => {
                try {
                    if (action === 'delete') {
                         // Use global handler
                         const desc = data ? `${data.name} (${data.role})` : "Employee";
                         await handleDelete("users", id, desc);
                    }
                    else if (action === 'approve') { await window.updateDoc(window.doc(window.db, "users", id), { status: 'active' }); showToast("Approved", "success"); }
                    else if (action === 'create' || action === 'update') {
                        const payload = { ...data, status: 'active', createdAt: window.serverTimestamp() };
                        if (action === 'update') await window.updateDoc(window.doc(window.db, "users", id), data);
                        else await window.addDoc(window.collection(window.db, "users"), payload);
                        setShowForm(false); showToast("Saved", "success");
                    }
                } catch(e) { console.error(e); }
            };

            if (viewId) return <EmployeeProfile t={t} employee={users.find(u => u.id === viewId)} onBack={()=>setViewId(null)} isHR={true} onError={onError} onEdit={(u) => { setFormData(u); setShowForm(true); setViewId(null); }} />;
            const pending = users.filter(u => u.status === 'pending');
            const active = users.filter(u => u.status !== 'pending');
            const list = tab === 'active' ? active : pending;

            return (
                <div className="space-y-6 animate-fade-in pb-10">
                    <div className="flex justify-between items-center"><h2 className="text-2xl font-bold text-slate-800">{t.employees}</h2><button onClick={()=>{setFormData({}); setShowForm(true)}} className="bg-primary-600 text-white px-4 py-2 rounded-xl flex gap-2 font-bold text-sm shadow-lg hover:bg-primary-700 transition-colors"><Icon name="plus" size={18}/> {t.addEmployee}</button></div>
                    <div className="flex gap-2 border-b border-slate-200"><button onClick={()=>setTab('active')} className={`px-4 py-2 font-bold text-sm border-b-2 transition-colors ${tab==='active'?'border-primary-600 text-primary-700':'border-transparent text-slate-500'}`}>{t.activeEmployees} ({active.length})</button><button onClick={()=>setTab('pending')} className={`px-4 py-2 font-bold text-sm border-b-2 transition-colors flex items-center gap-2 ${tab==='pending'?'border-primary-600 text-primary-700':'border-transparent text-slate-500'}`}>{t.joinRequests} {pending.length > 0 && <span className="bg-red-500 text-white text-[10px] px-1.5 rounded-full">{pending.length}</span>}</button></div>
                    {showForm && (<div className="bg-white p-6 rounded-2xl shadow-xl border border-slate-200 mb-6 animate-fade-in"><h3 className="font-bold mb-4">{t.addEmployee}</h3><form onSubmit={(e)=>{e.preventDefault(); handleAction(formData.id?'update':'create', formData.id, formData)}} className="grid grid-cols-2 gap-4"><input className="p-3 border rounded-xl" placeholder={t.fullName} required onChange={e=>setFormData({...formData, name:e.target.value})} /><input className="p-3 border rounded-xl" placeholder={t.email} required type="email" onChange={e=>setFormData({...formData, email:e.target.value})} /><input className="p-3 border rounded-xl" placeholder={t.position} onChange={e=>setFormData({...formData, position:e.target.value})} /><input className="p-3 border rounded-xl" placeholder={t.department} onChange={e=>setFormData({...formData, department:e.target.value})} /><input className="p-3 border rounded-xl" placeholder={t.salary} type="number" onChange={e=>setFormData({...formData, salary:e.target.value})} /><select className="p-3 border rounded-xl" onChange={e=>setFormData({...formData, role:e.target.value})}><option value="Employee">Employee</option><option value="Manager">Manager</option><option value="HR">HR</option></select><div className="flex gap-2"><input type="time" className="flex-1 p-3 border rounded-xl" value={formData.shiftStart||"09:00"} onChange={e=>setFormData({...formData, shiftStart:e.target.value})} /><input type="time" className="flex-1 p-3 border rounded-xl" value={formData.shiftEnd||"17:00"} onChange={e=>setFormData({...formData, shiftEnd:e.target.value})} /></div><div className="col-span-2 flex justify-end gap-2 mt-2"><button type="button" onClick={()=>setShowForm(false)} className="px-4 py-2 text-slate-500 font-bold">{t.cancel}</button><button className="px-6 py-2 bg-primary-600 text-white rounded-xl font-bold">{t.save}</button></div></form></div>)}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">{list.map(u => (<div key={u.id} className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition-all group relative"><div className="flex items-center gap-4 mb-4"><div className="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center font-bold text-slate-500 text-lg">{u.name?.charAt(0)}</div><div><h3 className="font-bold text-slate-800">{u.name}</h3><p className="text-xs text-primary-600 font-bold uppercase">{u.position || u.role}</p></div></div><div className="space-y-2 text-sm text-slate-500 mb-6"><div className="flex items-center gap-2"><Icon name="mail" size={14}/> {u.email}</div><div className="flex items-center gap-2"><Icon name="briefcase" size={14}/> {u.department}</div></div><div className="flex gap-2">{tab === 'active' ? (<><button onClick={()=>setViewId(u.id)} className="flex-1 py-2 bg-slate-50 text-slate-600 rounded-lg text-xs font-bold hover:bg-slate-100">{t.viewProfile}</button><button onClick={()=>handleAction('delete', u.id, u)} className="p-2 bg-red-50 text-red-500 rounded-lg hover:bg-red-100"><Icon name="trash-2" size={16}/></button></>) : (<><button onClick={()=>handleAction('approve', u.id)} className="flex-1 py-2 bg-green-50 text-green-600 rounded-lg text-xs font-bold hover:bg-green-100">{t.approveUser}</button><button onClick={()=>handleAction('delete', u.id, u)} className="p-2 bg-red-50 text-red-500 rounded-lg hover:bg-red-100"><Icon name="x" size={16}/></button></>)}</div></div>))}</div>
                </div>
            );
        };

        const Requests = ({ t, user, users = [], onError }) => {
            const [list, setList] = useState([]);
            const [delRequests, setDelRequests] = useState([]);
            const [showForm, setShowForm] = useState(false);
            const [activeTab, setActiveTab] = useState('requests');
            const [form, setForm] = useState({ type: 'Leave', reason: '' });
            const showToast = useToast();
            const handleDelete = useGlobalDelete(user);

            useEffect(() => {
                if(!window.firebaseLoaded) return;

                // Regular Requests
                const q = ['HR','Manager'].includes(user.role) ? window.collection(window.db, "requests") : window.query(window.collection(window.db, "requests"), window.where("userId", "==", user.uid));
                const unsub = window.onSnapshot(q, s => {
                     const data = s.docs.map(d => ({id:d.id, ...d.data()}));
                     data.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                     setList(data);
                }, (e) => { if(e.code === 'permission-denied' && onError) onError(); });

                // Deletion Requests (Manager Only)
                let unsubDel = () => {};
                if (user.role === 'Manager') {
                    const qDel = window.query(window.collection(window.db, "deletion_requests"), window.where("status", "==", "Pending"));
                    unsubDel = window.onSnapshot(qDel, s => {
                        setDelRequests(s.docs.map(d => ({id:d.id, ...d.data()})));
                    }, (e) => console.error(e));
                }

                return () => { unsub(); unsubDel(); }
            }, [user]);

            const submit = async (e) => {
                e.preventDefault();
                const status = ['HR', 'Manager'].includes(user.role) ? 'Approved' : 'Pending';
                await window.addDoc(window.collection(window.db, "requests"), { userId: user.uid, userName: user.name, ...form, status, timestamp: window.serverTimestamp() });
                setShowForm(false); showToast(t.reqSuccess, "success");
            };

            const statusUpdate = async (id, status) => { await window.updateDoc(window.doc(window.db, "requests", id), { status }); };

            const handleDelRequest = async (req, approve) => {
                try {
                    if (approve) {
                        await window.deleteDoc(window.doc(window.db, req.targetCollection, req.targetId));
                        await window.deleteDoc(window.doc(window.db, "deletion_requests", req.id));
                        showToast("Request Approved & Item Deleted", "success");
                    } else {
                        await window.deleteDoc(window.doc(window.db, "deletion_requests", req.id));
                        showToast("Request Rejected", "info");
                    }
                } catch(e) {
                    showToast("Action Failed", "error");
                }
            };

            return (
                <div className="space-y-6 animate-fade-in pb-10">
                    <div className="flex justify-between items-center"><h2 className="text-2xl font-bold text-slate-800">{t.requests}</h2><button onClick={()=>setShowForm(true)} className="bg-primary-600 text-white px-4 py-2 rounded-xl flex gap-2 font-bold text-sm shadow-lg"><Icon name="plus" size={18}/> {t.newRequest}</button></div>

                    {user.role === 'Manager' && (
                        <div className="flex gap-2 border-b border-slate-200 mb-4">
                            <button onClick={()=>setActiveTab('requests')} className={`px-4 py-2 font-bold text-sm border-b-2 transition-colors ${activeTab==='requests'?'border-primary-600 text-primary-700':'border-transparent text-slate-500'}`}>Leave/Loan Requests</button>
                            <button onClick={()=>setActiveTab('deletions')} className={`px-4 py-2 font-bold text-sm border-b-2 transition-colors flex items-center gap-2 ${activeTab==='deletions'?'border-primary-600 text-primary-700':'border-transparent text-slate-500'}`}>Deletion Requests {delRequests.length > 0 && <span className="bg-red-500 text-white text-[10px] px-1.5 rounded-full">{delRequests.length}</span>}</button>
                        </div>
                    )}

                    {showForm && (<div className="bg-white p-6 rounded-2xl shadow-xl mb-6"><form onSubmit={submit} className="space-y-4"><select className="w-full p-3 border rounded-xl" onChange={e=>setForm({...form, type:e.target.value})}><option value="Leave">{t.leave}</option><option value="Permission">{t.permission}</option><option value="Loan">{t.loan}</option></select>{form.type === 'Permission' && <div className="flex gap-2"><input type="time" required className="flex-1 p-3 border rounded-xl" onChange={e=>setForm({...form, from:e.target.value})} /><input type="time" required className="flex-1 p-3 border rounded-xl" onChange={e=>setForm({...form, to:e.target.value})} /></div>}<textarea className="w-full p-3 border rounded-xl" placeholder={t.reason} required onChange={e=>setForm({...form, reason:e.target.value})} /><div className="flex justify-end gap-2"><button type="button" onClick={()=>setShowForm(false)} className="px-4 py-2 text-slate-500 font-bold">{t.cancel}</button><button className="px-6 py-2 bg-primary-600 text-white rounded-xl font-bold">{t.submit}</button></div></form></div>)}

                    {activeTab === 'deletions' && user.role === 'Manager' ? (
                        <div className="grid gap-4">
                            {delRequests.length === 0 && <p className="text-slate-400 text-center py-10">No pending deletion requests.</p>}
                            {delRequests.map(req => (
                                <div key={req.id} className="bg-red-50 p-5 rounded-2xl border border-red-100 flex justify-between items-center">
                                    <div>
                                        <h3 className="font-bold text-red-800 flex items-center gap-2"><Icon name="trash-2" size={16}/> Delete Request</h3>
                                        <p className="text-sm text-red-600 mt-1"><b>{req.requesterName}</b> wants to delete {req.description}</p>
                                        <p className="text-xs text-red-400 mt-1 uppercase font-mono">{req.targetCollection} / {req.targetId}</p>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={()=>handleDelRequest(req, true)} className="bg-red-600 text-white px-4 py-2 rounded-lg text-xs font-bold shadow-sm hover:bg-red-700">Delete</button>
                                        <button onClick={()=>handleDelRequest(req, false)} className="bg-white text-slate-600 px-4 py-2 rounded-lg text-xs font-bold shadow-sm hover:bg-slate-50">Cancel</button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    ) : (
                        <div className="grid gap-4">{list.map(r => {
                            const reqUser = users.find(u => u.uid === r.userId);
                            return (<div key={r.id} className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex justify-between items-center"><div><div className="flex items-center gap-3 mb-1"><span className="font-bold text-slate-700">{r.type}</span><span className={`text-[10px] uppercase font-bold px-2 py-0.5 rounded-full ${r.status==='Approved'?'bg-green-100 text-green-700':r.status==='Rejected'?'bg-red-100 text-red-700':'bg-yellow-100 text-yellow-700'}`}>{r.status}</span><span className="text-[10px] text-slate-400 font-mono ml-2">{new Date(r.timestamp?.seconds*1000).toLocaleString()}</span></div><p className="text-sm text-slate-600">{r.reason} {r.from && <span className="font-mono bg-slate-100 px-1 rounded ml-1">{r.from}-{r.to}</span>}</p><div className="mt-2 flex items-start gap-1 text-slate-400"><Icon name="user" size={12} className="mt-0.5"/><div><p className="text-xs font-bold text-slate-500">{r.userName}</p>{reqUser?.department && <p className="text-[10px] uppercase text-slate-300">{reqUser.department}</p>}</div></div></div>
                            <div className="flex items-center gap-2">
                                {['HR','Manager'].includes(user.role) && r.status === 'Pending' && (<div className="flex gap-2 mr-2"><button onClick={()=>statusUpdate(r.id, 'Approved')} className="p-2 bg-green-50 text-green-600 rounded-lg hover:bg-green-100"><Icon name="check" size={18}/></button><button onClick={()=>statusUpdate(r.id, 'Rejected')} className="p-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100"><Icon name="x" size={18}/></button></div>)}
                                {['HR','Manager'].includes(user.role) && <button onClick={()=>handleDelete("requests", r.id, `Request: ${r.type} by ${r.userName}`)} className="p-2 text-slate-300 hover:text-red-500 transition-colors"><Icon name="trash-2" size={16}/></button>}
                            </div>
                            </div>);
                        })}</div>
                    )}
                </div>
            );
        };

        const Attendance = ({ t, user, onError }) => {
            const [logs, setLogs] = useState([]);
            const [status, setStatus] = useState(null);
            const [loading, setLoading] = useState(false);
            const showToast = useToast();
            const handleDelete = useGlobalDelete(user);

            useEffect(() => {
                if(!window.firebaseLoaded) return;
                // FIX: Removed orderBy/where conflict
                const q = user.role === 'HR' ? window.query(window.collection(window.db, "attendance"), window.orderBy("timestamp", "desc")) : window.query(window.collection(window.db, "attendance"), window.where("userId", "==", user.uid));
                window.onSnapshot(q, s => {
                    const data = s.docs.map(d => ({id:d.id, ...d.data()}));
                    if (user.role !== 'HR') data.sort((a,b)=> (b.timestamp?.seconds||0) - (a.timestamp?.seconds||0));
                    setLogs(data);
                    if(data[0] && data[0].type === 'in' && new Date(data[0].timestamp.seconds*1000).toDateString() === new Date().toDateString()) setStatus('Checked In'); else setStatus(null);
                }, (e) => { if(e.code === 'permission-denied' && onError) onError(); });
            }, [user]);

            const punch = (type) => {
                setLoading(true);
                if(!navigator.geolocation) { showToast(t.gpsRequired, "error"); setLoading(false); return; }
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    const loc = `${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)}`;
                    await window.addDoc(window.collection(window.db, "attendance"), { userId: user.uid, userName: user.name, type, location: loc, timestamp: window.serverTimestamp() });
                    showToast("Success", "success"); setLoading(false);
                }, () => { showToast(t.gpsRequired, "error"); setLoading(false); }, { enableHighAccuracy: true });
            };

            return (
                <div className="space-y-6 pb-10 animate-fade-in">
                    <div className="bg-white rounded-3xl p-10 shadow-sm border border-slate-200 text-center"><div className="text-6xl font-bold text-slate-800 font-mono tracking-tighter mb-8">{new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div><div className="flex justify-center">{!status ? <button onClick={()=>punch('in')} disabled={loading} className="px-10 py-4 bg-emerald-600 text-white rounded-2xl font-bold text-lg shadow-xl shadow-emerald-200 hover:shadow-2xl hover:bg-emerald-700 transition-all flex items-center gap-3 disabled:opacity-50"><Icon name="log-in" /> {loading ? "..." : t.checkIn}</button> : <button onClick={()=>punch('out')} disabled={loading} className="px-10 py-4 bg-red-600 text-white rounded-2xl font-bold text-lg shadow-xl shadow-red-200 hover:shadow-2xl hover:bg-red-700 transition-all flex items-center gap-3 disabled:opacity-50"><Icon name="log-out" /> {loading ? "..." : t.checkOut}</button>}</div></div>
                    <div className="bg-white rounded-2xl border border-slate-200 overflow-hidden"><table className="w-full text-sm text-left"><thead className="bg-slate-50 text-slate-500"><tr><th className="p-4">{t.date}</th><th className="p-4">{t.type}</th><th className="p-4">Time</th><th className="p-4">Loc</th>{['HR','Manager'].includes(user.role) && <th className="p-4">{t.actions}</th>}</tr></thead><tbody className="divide-y divide-slate-100">{logs.map(l => (<tr key={l.id}><td className="p-4 font-medium">{new Date(l.timestamp?.seconds*1000).toLocaleDateString()}</td><td className="p-4"><span className={`px-2 py-1 rounded text-xs font-bold ${l.type==='in'?'bg-emerald-50 text-emerald-700':'bg-rose-50 text-rose-700'}`}>{l.type.toUpperCase()}</span></td><td className="p-4 font-mono">{new Date(l.timestamp?.seconds*1000).toLocaleTimeString()}</td><td className="p-4 text-xs text-slate-400">{l.location}</td>{['HR','Manager'].includes(user.role) && <td className="p-4"><button onClick={()=>handleDelete("attendance", l.id, `Attendance: ${l.userName} (${l.type})`)} className="text-slate-400 hover:text-red-500"><Icon name="trash-2" size={16}/></button></td>}</tr>))}</tbody></table></div>
                </div>
            );
        };

        const Chat = ({ t, user, onError }) => {
            const [activeChannel, setActiveChannel] = useState('general');
            const [messages, setMessages] = useState([]);
            const [newMessage, setNewMessage] = useState("");
            const [usersList, setUsersList] = useState([]);
            const bottomRef = useRef(null);

            useEffect(() => {
                if(!window.firebaseLoaded) return;
                const unsub = window.onSnapshot(window.collection(window.db, "users"), s => setUsersList(s.docs.map(d => ({id:d.id, ...d.data()})).filter(u => u.uid !== user.uid)), (e) => { if(e.code === 'permission-denied' && onError) onError(); });
                return () => unsub();
            }, []);

            useEffect(() => {
                if(!window.firebaseLoaded) return;
                // FIX: Remove orderBy to fix index error
                const q = window.query(window.collection(window.db, "messages"), window.where("channelId", "==", activeChannel));
                const unsub = window.onSnapshot(q, s => { 
                    const data = s.docs.map(d => ({id:d.id, ...d.data()}));
                    data.sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));
                    setMessages(data); 
                    setTimeout(() => bottomRef.current?.scrollIntoView({ behavior: 'smooth' }), 100); 
                }, (e) => { if(e.code === 'permission-denied' && onError) onError(); });
                return () => unsub();
            }, [activeChannel]);

            const send = async (e) => {
                e.preventDefault();
                if(!newMessage.trim()) return;
                await window.addDoc(window.collection(window.db, "messages"), { text: newMessage, userId: user.uid, userName: user.name, channelId: activeChannel, timestamp: window.serverTimestamp() });
                setNewMessage("");
            };

            const getDmId = (uid1, uid2) => [uid1, uid2].sort().join('_');

            return (
                <div className="flex h-[calc(100vh-140px)] bg-white rounded-3xl shadow-xl border border-slate-200 overflow-hidden animate-slide-up">
                    <div className="w-72 bg-slate-50 border-r border-slate-200 flex flex-col">
                        <div className="p-4 border-b border-slate-200"><h3 className="font-bold text-slate-700 mb-3">{t.channels}</h3><button onClick={() => setActiveChannel('general')} className={`w-full text-left px-3 py-2 rounded-lg text-sm mb-1 ${activeChannel === 'general' ? 'bg-primary-100 text-primary-700 font-bold' : 'text-slate-600 hover:bg-slate-200'}`}># {t.generalChannel}</button><button onClick={() => setActiveChannel(`dept_${user.department}`)} className={`w-full text-left px-3 py-2 rounded-lg text-sm ${activeChannel.startsWith('dept_') ? 'bg-primary-100 text-primary-700 font-bold' : 'text-slate-600 hover:bg-slate-200'}`}># {t.deptChannel}</button></div>
                        <div className="p-4 flex-1 overflow-y-auto"><h3 className="font-bold text-slate-700 mb-3">{t.directMessages}</h3>{usersList.map(u => (<button key={u.id} onClick={() => setActiveChannel(getDmId(user.uid, u.uid))} className={`w-full flex items-center gap-2 px-3 py-2 rounded-lg text-sm mb-1 ${activeChannel === getDmId(user.uid, u.uid) ? 'bg-primary-100 text-primary-700 font-bold' : 'text-slate-600 hover:bg-slate-200'}`}><div className="w-6 h-6 rounded-full bg-slate-300 flex items-center justify-center text-[10px] text-white">{u.name?.charAt(0)}</div><span className="truncate">{u.name}</span></button>))}</div>
                    </div>
                    <div className="flex-1 flex flex-col bg-slate-100 relative">
                        <div className="p-4 bg-white border-b border-slate-200 shadow-sm z-10 flex justify-between items-center"><div className="flex items-center gap-3"><div className="w-10 h-10 bg-primary-100 rounded-full flex items-center justify-center text-primary-600"><Icon name="hash" size={20}/></div><h3 className="font-bold text-slate-800">{activeChannel === 'general' ? t.generalChannel : 'Chat'}</h3></div></div>
                        <div className="flex-1 overflow-y-auto p-6 space-y-4 z-10">{messages.map((m, i) => { const isMe = m.userId === user.uid; return (<div key={m.id} className={`flex flex-col ${isMe ? 'items-end' : 'items-start'}`}><div className={`max-w-[75%] px-4 py-2 rounded-xl shadow-sm ${isMe ? 'bg-primary-600 text-white rounded-br-none' : 'bg-white text-slate-800 rounded-bl-none'}`}><p className="text-sm">{m.text}</p></div></div>) })}<div ref={bottomRef}></div></div>
                        <div className="p-4 bg-white border-t border-slate-200 z-10"><form onSubmit={send} className="flex gap-2"><input value={newMessage} onChange={e => setNewMessage(e.target.value)} placeholder="Type..." className="flex-1 p-3 border rounded-xl" /><button className="p-3 bg-primary-600 text-white rounded-xl"><Icon name="send" size={18}/></button></form></div>
                    </div>
                </div>
            );
        };

        const Meetings = ({ t, user, onError }) => {
            const [meetings, setMeetings] = useState([]);
            const [showForm, setShowForm] = useState(false);
            const [newMeeting, setNewMeeting] = useState({ title: '', type: 'online', date: '', time: '' });
            const showToast = useToast();
            const handleDelete = useGlobalDelete(user);

            useEffect(() => {
                if(!window.firebaseLoaded) return;
                const q = window.query(window.collection(window.db, "meetings"), window.orderBy("timestamp", "desc"));
                window.onSnapshot(q, s => setMeetings(s.docs.map(d => ({id:d.id, ...d.data()}))), (e) => { if(e.code === 'permission-denied' && onError) onError(); });
            }, []);

            const create = async (e) => {
                e.preventDefault();
                const link = newMeeting.type === 'online' ? `https://meet.jit.si/HR_${Date.now()}` : '';
                await window.addDoc(window.collection(window.db, "meetings"), { ...newMeeting, link, createdBy: user.name, timestamp: window.serverTimestamp() });
                setShowForm(false); showToast("Meeting Scheduled", "success");
            };

            return (
                <div className="space-y-6 animate-slide-up">
                    <div className="flex justify-between items-center"><h2 className="text-2xl font-bold text-slate-800">{t.meetings}</h2><button onClick={()=>setShowForm(true)} className="bg-primary-600 text-white px-4 py-2 rounded-xl flex gap-2 font-bold text-sm"><Icon name="plus" size={18}/> {t.scheduleMeeting}</button></div>
                    {showForm && (<div className="bg-white p-6 rounded-2xl shadow-xl mb-6"><form onSubmit={create} className="space-y-4"><input className="w-full p-3 border rounded-xl" placeholder={t.meetingTitle} onChange={e=>setNewMeeting({...newMeeting, title:e.target.value})} /><div className="flex gap-2"><select className="flex-1 p-3 border rounded-xl" onChange={e=>setNewMeeting({...newMeeting, type:e.target.value})}><option value="online">Online</option><option value="onsite">Onsite</option></select><input type="date" className="flex-1 p-3 border rounded-xl" onChange={e=>setNewMeeting({...newMeeting, date:e.target.value})} /><input type="time" className="flex-1 p-3 border rounded-xl" onChange={e=>setNewMeeting({...newMeeting, time:e.target.value})} /></div><button className="w-full p-3 bg-primary-600 text-white rounded-xl font-bold">{t.create}</button></form></div>)}
                    <div className="grid gap-4">{meetings.map(m => (<div key={m.id} className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex justify-between items-center"><div className="flex items-center gap-4"><div className="w-12 h-12 bg-primary-100 text-primary-600 rounded-xl flex items-center justify-center"><Icon name="video" size={24}/></div><div><h3 className="font-bold text-lg">{m.title}</h3><p className="text-sm text-slate-500">{m.date} at {m.time}</p></div></div><div className="flex items-center gap-3">{m.link && <a href={m.link} target="_blank" className="bg-primary-50 text-primary-600 px-4 py-2 rounded-lg font-bold text-sm">Join</a>}{['HR','Manager'].includes(user.role) && <button onClick={()=>handleDelete("meetings", m.id, `Meeting: ${m.title}`)} className="p-2 text-slate-300 hover:text-red-500"><Icon name="trash-2" size={16}/></button>}</div></div>))}</div>
                </div>
            );
        };

        const Reports = ({ t }) => {
            const [filters, setFilters] = useState({
                type: 'attendance',
                startDate: new Date().toISOString().split('T')[0],
                endDate: new Date().toISOString().split('T')[0],
                department: 'All',
                employeeId: 'All'
            });
            const [data, setData] = useState([]);
            const [users, setUsers] = useState([]);
            const [loading, setLoading] = useState(false);
            const [departments, setDepartments] = useState([]);

            useEffect(() => {
                if(!window.firebaseLoaded) return;
                const unsub = window.onSnapshot(window.collection(window.db, "users"), s => {
                    const u = s.docs.map(d => ({id:d.id, ...d.data()}));
                    setUsers(u);
                    setDepartments([...new Set(u.map(user => user.department).filter(Boolean))]);
                });
                return () => unsub();
            }, []);

            useEffect(() => {
                if(!window.firebaseLoaded) return;
                const fetchReport = async () => {
                    setLoading(true);
                    try {
                        let result = [];
                        const start = new Date(filters.startDate); start.setHours(0,0,0,0);
                        const end = new Date(filters.endDate); end.setHours(23,59,59,999);

                        // 1. Attendance Report
                        if (filters.type === 'attendance') {
                            const q = window.query(window.collection(window.db, "attendance"));
                            const snap = await window.getDocs(q);
                            result = snap.docs.map(d => ({id:d.id, ...d.data()})).filter(item => {
                                const date = item.timestamp ? new Date(item.timestamp.seconds * 1000) : null;
                                return date && date >= start && date <= end;
                            }).map(item => {
                                const user = users.find(u => u.uid === item.userId || u.id === item.userId);
                                return { ...item, userName: user?.name || item.userName, department: user?.department };
                            });
                        }
                        // 2. Requests Report
                        else if (filters.type === 'requests') {
                            const q = window.query(window.collection(window.db, "requests"));
                            const snap = await window.getDocs(q);
                            result = snap.docs.map(d => ({id:d.id, ...d.data()})).filter(item => {
                                const date = item.timestamp ? new Date(item.timestamp.seconds * 1000) : null;
                                return date && date >= start && date <= end;
                            }).map(item => {
                                const user = users.find(u => u.uid === item.userId || u.id === item.userId);
                                return { ...item, department: user?.department };
                            });
                        }
                        // 3. Employees Directory
                        else if (filters.type === 'employees') {
                            result = users;
                        }
                        // 4. Financials
                        else if (filters.type === 'financials') {
                             // Fetch Attendance
                             const attQ = window.query(window.collection(window.db, "attendance"));
                             const attSnap = await window.getDocs(attQ);
                             const allAttendance = attSnap.docs.map(d => ({...d.data()}));

                             // Fetch Deductions
                             const dedQ = window.query(window.collection(window.db, "deductions"));
                             const dedSnap = await window.getDocs(dedQ);
                             const allDeductions = dedSnap.docs.map(d => ({...d.data()}));

                             result = users.map(user => {
                                 const userLogs = allAttendance.filter(l => (l.userId === user.uid || l.userId === user.id) && l.timestamp && new Date(l.timestamp.seconds*1000) >= start && new Date(l.timestamp.seconds*1000) <= end);
                                 const userDeds = allDeductions.filter(d => (d.userId === user.uid || d.userId === user.id) && d.date && new Date(d.date) >= start && new Date(d.date) <= end);

                                 const financials = window.HRUtils ? window.HRUtils.calculateFinancials(user, userLogs, userDeds) : {};
                                 return { ...user, ...financials, logsCount: userLogs.length, dedsCount: userDeds.length };
                             });
                        }

                        // Apply Common Filters
                        if (filters.department !== 'All') {
                            result = result.filter(item => item.department === filters.department);
                        }
                        if (filters.employeeId !== 'All') {
                            result = result.filter(item => (item.userId === filters.employeeId || item.id === filters.employeeId || item.uid === filters.employeeId));
                        }

                        // Sort by date if available, else by name
                        result.sort((a,b) => {
                            const dateA = a.timestamp?.seconds || (a.date ? new Date(a.date).getTime()/1000 : 0);
                            const dateB = b.timestamp?.seconds || (b.date ? new Date(b.date).getTime()/1000 : 0);
                            return dateB - dateA;
                        });

                        setData(result);
                    } catch (e) {
                        console.error(e);
                    } finally {
                        setLoading(false);
                    }
                };

                // Debounce slightly to avoid rapid firing if users type fast (though here it's selects/dates)
                const timer = setTimeout(fetchReport, 500);
                return () => clearTimeout(timer);
            }, [filters, users]); // Re-run when filters or users list changes

            const print = () => window.print();

            return (
                <div className="space-y-6 animate-fade-in pb-10">
                    <div className="flex justify-between items-center no-print">
                        <h2 className="text-2xl font-bold text-slate-800">{t.reports}</h2>
                        <button onClick={print} className="bg-slate-800 text-white px-4 py-2 rounded-xl flex gap-2 font-bold text-sm shadow-lg hover:bg-slate-700 transition-colors"><Icon name="printer" size={18}/> {t.printReport}</button>
                    </div>

                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 no-print">
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                            <div><label className="text-xs font-bold text-slate-500 uppercase block mb-1">{t.reportType}</label><select className="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm font-semibold outline-none focus:border-primary-500" value={filters.type} onChange={e=>setFilters({...filters, type:e.target.value})}><option value="attendance">{t.attendanceReport}</option><option value="requests">{t.requests}</option><option value="employees">{t.employees}</option><option value="financials">Financials</option></select></div>
                            {filters.type !== 'employees' && (<>
                                <div><label className="text-xs font-bold text-slate-500 uppercase block mb-1">{t.from}</label><input type="date" className="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm font-semibold outline-none focus:border-primary-500" value={filters.startDate} onChange={e=>setFilters({...filters, startDate:e.target.value})} /></div>
                                <div><label className="text-xs font-bold text-slate-500 uppercase block mb-1">{t.to}</label><input type="date" className="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm font-semibold outline-none focus:border-primary-500" value={filters.endDate} onChange={e=>setFilters({...filters, endDate:e.target.value})} /></div>
                            </>)}
                            <div><label className="text-xs font-bold text-slate-500 uppercase block mb-1">{t.filterByDept}</label><select className="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm font-semibold outline-none focus:border-primary-500" value={filters.department} onChange={e=>setFilters({...filters, department:e.target.value})}><option value="All">{t.allDepts}</option>{departments.map(d=><option key={d} value={d}>{d}</option>)}</select></div>
                            <div><label className="text-xs font-bold text-slate-500 uppercase block mb-1">Employee</label><select className="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm font-semibold outline-none focus:border-primary-500" value={filters.employeeId} onChange={e=>setFilters({...filters, employeeId:e.target.value})}><option value="All">All Employees</option>{users.map(u=><option key={u.id} value={u.uid || u.id}>{u.name}</option>)}</select></div>
                        </div>
                    </div>

                    <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden print-container">
                        <div className="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                             <div>
                                <h3 className="font-bold text-lg text-slate-800 capitalize">{filters.type} Report</h3>
                                <p className="text-xs text-slate-500">{filters.type !== 'employees' ? `${filters.startDate} to ${filters.endDate}` : `Generated on ${new Date().toLocaleDateString()}`}</p>
                             </div>
                             <div className="text-right">
                                <p className="text-xs text-slate-400 font-bold uppercase">Total Records</p>
                                <p className="text-2xl font-bold text-slate-700">{data.length}</p>
                             </div>
                        </div>

                        {loading ? <div className="p-10 text-center text-slate-400">Loading data...</div> : (
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm text-left">
                                    <thead className="bg-slate-50 text-slate-500 uppercase text-xs font-bold">
                                        <tr>
                                            {filters.type === 'attendance' && <><th className="p-4">{t.date}</th><th className="p-4">{t.fullName}</th><th className="p-4">{t.type}</th><th className="p-4">Time</th><th className="p-4">Late</th><th className="p-4">Dept</th></>}
                                            {filters.type === 'requests' && <><th className="p-4">{t.date}</th><th className="p-4">{t.fullName}</th><th className="p-4">{t.type}</th><th className="p-4">{t.reason}</th><th className="p-4">{t.status}</th><th className="p-4">Dept</th></>}
                                            {filters.type === 'employees' && <><th className="p-4">{t.fullName}</th><th className="p-4">{t.role}</th><th className="p-4">{t.department}</th><th className="p-4">{t.email}</th><th className="p-4">{t.status}</th></>}
                                            {filters.type === 'financials' && <><th className="p-4">{t.fullName}</th><th className="p-4">{t.salary}</th><th className="p-4">Net Salary</th><th className="p-4">Deductions</th><th className="p-4">Late Cost</th></>}
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100">
                                        {data.map((item, i) => (
                                            <tr key={item.id || i} className="hover:bg-slate-50/50 transition-colors">
                                                {filters.type === 'attendance' && <>
                                                    <td className="p-4 font-medium text-slate-700">{new Date(item.timestamp.seconds*1000).toLocaleDateString()}</td>
                                                    <td className="p-4 font-bold text-slate-800">{item.userName}</td>
                                                    <td className="p-4"><span className={`px-2 py-1 rounded text-xs font-bold ${item.type==='in'?'bg-emerald-50 text-emerald-700':'bg-rose-50 text-rose-700'}`}>{item.type.toUpperCase()}</span></td>
                                                    <td className="p-4 font-mono text-slate-600">{new Date(item.timestamp.seconds*1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</td>
                                                    <td className="p-4 font-bold text-red-500">{item.type === 'in' && window.HRUtils ? `+${window.HRUtils.calculateLateness(item.timestamp.seconds, users.find(u=>u.uid===item.userId)?.shiftStart)}m` : '-'}</td>
                                                    <td className="p-4 text-slate-500">{item.department}</td>
                                                </>}
                                                {filters.type === 'requests' && <>
                                                    <td className="p-4 font-medium text-slate-700">{new Date(item.timestamp.seconds*1000).toLocaleDateString()}</td>
                                                    <td className="p-4 font-bold text-slate-800">{item.userName}</td>
                                                    <td className="p-4"><span className="px-2 py-1 bg-slate-100 rounded text-xs font-bold text-slate-600">{item.type}</span></td>
                                                    <td className="p-4 text-slate-600 max-w-[200px] truncate">{item.reason}</td>
                                                    <td className="p-4"><span className={`px-2 py-1 rounded text-xs font-bold ${item.status==='Approved'?'bg-green-50 text-green-700':item.status==='Rejected'?'bg-red-50 text-red-700':'bg-yellow-50 text-yellow-700'}`}>{item.status}</span></td>
                                                    <td className="p-4 text-slate-500">{item.department}</td>
                                                </>}
                                                {filters.type === 'employees' && <>
                                                    <td className="p-4 font-bold text-slate-800">{item.name}</td>
                                                    <td className="p-4 text-slate-600">{item.position || item.role}</td>
                                                    <td className="p-4 text-slate-600">{item.department}</td>
                                                    <td className="p-4 text-slate-500 text-sm">{item.email}</td>
                                                    <td className="p-4"><span className={`px-2 py-1 rounded text-xs font-bold ${item.status==='active'?'bg-green-50 text-green-700':'bg-yellow-50 text-yellow-700'}`}>{item.status}</span></td>
                                                </>}
                                                {filters.type === 'financials' && <>
                                                    <td className="p-4 font-bold text-slate-800">{item.name}</td>
                                                    <td className="p-4 font-mono text-slate-600">${Number(item.salary).toLocaleString()}</td>
                                                    <td className="p-4 font-mono font-bold text-emerald-600">${Number(item.netSalary).toLocaleString()}</td>
                                                    <td className="p-4 font-mono text-red-500">-${item.totalDeductions}</td>
                                                    <td className="p-4 font-mono text-orange-500">-${item.lateCost}</td>
                                                </>}
                                            </tr>
                                        ))}
                                        {data.length === 0 && <tr><td colSpan="6" className="p-10 text-center text-slate-400">No records found matching filters.</td></tr>}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('dashboard');
            const [lang, setLang] = useState('en');
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const [loadingAuth, setLoadingAuth] = useState(true);
            const [permError, setPermError] = useState(false);
            const [globalRequests, setGlobalRequests] = useState([]);
            const [allUsers, setAllUsers] = useState([]);
            
            const t = TRANSLATIONS[lang];

            useEffect(() => {
                if(!window.firebaseLoaded) { setLoadingAuth(false); return; }
                const unsub = window.onAuthStateChanged(window.auth, (u) => {
                    if (u) {
                        window.onSnapshot(window.doc(window.db, "users", u.uid), (doc) => {
                            if (doc.exists()) setUser({ ...u, ...doc.data() });
                            else { window.signOut(window.auth); setUser(null); }
                            setLoadingAuth(false);
                        }, (e) => { if(e.code==='permission-denied') setPermError(true); setLoadingAuth(false); });
                        
                        window.onSnapshot(window.collection(window.db, "requests"), 
                            s => setGlobalRequests(s.docs.map(d=>d.data())), 
                            (e) => { if(e.code==='permission-denied') setPermError(true); }
                        );
                        window.onSnapshot(window.collection(window.db, "users"), 
                            s => setAllUsers(s.docs.map(d=>d.data())),
                            (e) => { if(e.code==='permission-denied') setPermError(true); }
                        );
                    } else { setUser(null); setLoadingAuth(false); }
                });
                return () => unsub();
            }, []);

            if (loadingAuth) return <div className="h-screen flex items-center justify-center text-slate-400 animate-pulse">Loading System...</div>;
            if (!user) return <ToastProvider><div dir={lang==='ar'?'rtl':'ltr'} className={lang==='ar'?'font-arabic':''}><AuthScreen t={t} onLogin={setUser} onError={()=>setPermError(true)} /></div></ToastProvider>;
            if (user.status === 'pending') return <PendingScreen t={t} onLogout={() => window.signOut(window.auth)} />;

            const menu = [
                { id: 'dashboard', icon: 'layout-grid', label: t.dashboard },
                { id: 'attendance', icon: 'clock', label: t.attendance },
                { id: 'requests', icon: 'file-text', label: t.requests },
                { id: 'chat', icon: 'message-circle', label: t.chat },
                { id: 'meetings', icon: 'video', label: t.meetings },
            ];
            if(['HR','Manager'].includes(user.role)) {
                menu.push({ id: 'employees', icon: 'users', label: t.employees });
                menu.push({ id: 'reports', icon: 'bar-chart-2', label: t.reports });
            }

            return (
                <ToastProvider>
                    {permError && <PermissionHelpModal onClose={()=>setPermError(false)} />}
                    <div dir={lang==='ar'?'rtl':'ltr'} className={`flex h-full ${lang==='ar'?'font-arabic':''}`}>
                        <div className={`no-print fixed md:static inset-y-0 z-30 w-72 bg-slate-900 text-white transform transition-transform duration-300 ${sidebarOpen ? 'translate-x-0' : (lang==='ar'?'translate-x-full':'-translate-x-full')} md:translate-x-0 flex flex-col shadow-2xl`}>
                            <div className="p-8 flex items-center justify-between"><h1 className="text-xl font-bold flex gap-3 items-center"><span className="bg-primary-600 p-1.5 rounded-lg"><Icon name="hexagon" className="text-white"/></span> {t.appName}</h1><button onClick={()=>setSidebarOpen(false)} className="md:hidden text-slate-400"><Icon name="x"/></button></div>
                            <div className="px-6 mb-6"><div className="bg-slate-800/50 p-4 rounded-xl border border-slate-700 flex items-center gap-3"><div className="w-10 h-10 rounded-full bg-gradient-to-br from-primary-500 to-purple-600 flex items-center justify-center font-bold text-sm">{user.name?.charAt(0)}</div><div className="overflow-hidden"><p className="font-bold text-sm truncate">{user.name}</p><p className="text-[10px] text-slate-400 uppercase tracking-wider">{t.roles[user.role.toLowerCase()]}</p></div></div></div>
                            <nav className="flex-1 px-4 space-y-1 overflow-y-auto">{menu.map(m => (<button key={m.id} onClick={()=>{setView(m.id); setSidebarOpen(false)}} className={`w-full flex items-center gap-4 px-4 py-3.5 rounded-xl transition-all group ${view===m.id ? 'bg-primary-600 text-white shadow-lg font-medium' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}`}><Icon name={m.icon} size={20} className={view===m.id?'text-white':'text-slate-500 group-hover:text-white'} /><span>{m.label}</span></button>))}</nav>
                            <div className="p-4"><button onClick={()=>window.signOut(window.auth)} className="w-full py-3 bg-slate-800 rounded-xl text-slate-400 hover:text-red-400 hover:bg-red-900/20 transition-all flex items-center justify-center gap-2 font-medium text-sm"><Icon name="log-out" size={16}/> Logout</button></div>
                        </div>
                        <div className="flex-1 flex flex-col overflow-hidden relative bg-slate-50/50">
                            <header className="no-print h-20 bg-white/80 backdrop-blur border-b border-slate-200 flex items-center justify-between px-8 sticky top-0 z-20"><div className="flex items-center gap-4"><button onClick={()=>setSidebarOpen(true)} className="md:hidden text-slate-500"><Icon name="menu"/></button><h2 className="text-xl font-bold text-slate-800">{menu.find(m=>m.id===view)?.label || t.dashboard}</h2></div><button onClick={()=>setLang(l=>l==='en'?'ar':'en')} className="px-4 py-2 border border-slate-200 rounded-full text-xs font-bold hover:bg-slate-50 transition-colors uppercase">{lang}</button></header>
                            <main className="flex-1 overflow-auto p-6 md:p-10">
                                {view === 'dashboard' && <Dashboard t={t} user={user} setView={setView} requests={globalRequests} users={allUsers} />}
                                {view === 'attendance' && <Attendance t={t} user={user} onError={()=>setPermError(true)} />}
                                {view === 'employees' && <Employees t={t} user={user} onError={()=>setPermError(true)} />}
                                {view === 'requests' && <Requests t={t} user={user} users={allUsers} onError={()=>setPermError(true)} />}
                                {view === 'chat' && <Chat t={t} user={user} onError={()=>setPermError(true)} />}
                                {view === 'meetings' && <Meetings t={t} user={user} onError={()=>setPermError(true)} />}
                                {view === 'reports' && <Reports t={t} />}
                            </main>
                        </div>
                    </div>
                </ToastProvider>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
